<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.june.dao.back.bussiness.referenceFile.FileCodeDao">
	<!-- 查询列表SQL -->
	<sql id="selectData">
		SELECT
			v.FILE_ID 		AS fileId,
			s.FILE_NAME 	AS fileName,
			v.CODE_ID 		AS errorId,
			c.ERROR_CODE 	AS errorCode,
			v.ADD_USER_ID 	AS addUserId,
			v.ADD_TIME 		AS addTime
		FROM
			FILE_CODE v
		LEFT JOIN ERROR_CODE c ON c.ERROR_ID = v.CODE_ID
		LEFT JOIN REFERENCE_FILE s ON s.FILE_ID = v.FILE_ID
		WHERE 1 = 1
		<if test="fileName != null and fileName != ''">
			AND s.FILE_NAME LIKE CONCAT(CONCAT('%', #{fileName}), '%')
		</if>
		<if test="errorCode != null and errorCode != ''">
			AND c.ERROR_CODE LIKE CONCAT(CONCAT('%', #{errorCode}), '%')
		</if>
		<if test="errorId != null and errorId != ''">
			AND v.CODE_ID = #{errorId}
		</if>
		<if test="fileId != null and fileId != ''">
			AND v.FILE_ID = #{fileId}
		</if>
			ORDER BY v.ADD_TIME
	</sql>
	<!-- 查询参考文件与故障代码列表 -->
	<select id="getPageList" resultType="com.june.dto.back.bussiness.referenceFile.FileCodeDto"
		parameterType="com.june.dto.back.bussiness.referenceFile.FileCodeDto">
		<include refid="pagetop" />
		<include refid="selectData" />
		<include refid="pageend" />
	</select>
	<sql id="pagetop">
		<![CDATA[SELECT * FROM (SELECT ROWNUM AS PNUM, TNUM.* FROM ( ]]>
	</sql>
	<sql id="pageend">
		<![CDATA[) TNUM WHERE ROWNUM <= #{startadd} + #{pageSize}) TPAGE WHERE TPAGE.PNUM > #{start}]]>
	</sql>
	<sql id="pagelimit">
		limit #{start}, #{pageSize}
	</sql>

	<!-- 查询总条数 -->
	<select id="getTotal" resultType="int">
		SELECT COUNT(1) FROM ( <include refid="selectData" /> ) T
	</select>

	<!-- 查询所有参考文件与故障代码列表 -->
	<select id="getList" resultType="com.june.dto.back.bussiness.referenceFile.FileCodeDto" 
		parameterType="com.june.dto.back.bussiness.referenceFile.FileCodeDto">
		<include refid="selectData" />
	</select>
	
	<!-- 根据参考文件与故障代码id 获取一条记录 -->
	<select id="get" parameterType="com.june.dto.back.bussiness.referenceFile.FileCodeDto" 
		resultType="com.june.dto.back.bussiness.referenceFile.FileCodeDto">
		SELECT
			v.FILE_ID AS fileId,
			s.FILE_NAME AS fileName,
			v.CODE_ID AS errorId,
			c.ERROR_CODE AS errorCode,
			v.ADD_USER_ID AS addUserId,
			v.ADD_TIME AS addTime
		FROM
			FILE_CODE v
		LEFT JOIN ERROR_CODE c ON c.ERROR_ID = v.CODE_ID
		LEFT JOIN REFERENCE_FILE s ON s.FILE_ID = v.FILE_ID
		WHERE
			v.FILE_ID = #{fileId} AND v.CODE_ID = #{errorId}
	</select>

	<!-- 添加参考文件与故障代码信息 -->
	<insert id="add" parameterType="com.june.dto.back.bussiness.referenceFile.FileCodeDto">
		INSERT INTO FILE_CODE
		  (FILE_ID,
		   CODE_ID,
		   ADD_USER_ID,
		   ADD_TIME)
		VALUES
		  (#{fileId},
		   #{errorId},
		   #{addUserId},
		   SYSDATE)
	</insert>
	
	<!-- 批量添加 -->
	<insert id="addList" parameterType="java.util.List">
		<![CDATA[ 
		INSERT INTO FILE_CODE
		  (FILE_ID,
		   CODE_ID,
		   ADD_USER_ID,
		   ADD_TIME) ]]>
		<foreach collection="list" item="item" index="index" separator="UNION ALL">
		   SELECT
			   #{item.fileId},
			   #{item.errorId},
			   #{item.addUserId},
			   SYSDATE 
		   FROM DUAL
		</foreach>
	</insert>

	<!-- 编辑参考文件与故障代码信息 -->
	<update id="update" parameterType="com.june.dto.back.bussiness.referenceFile.FileCodeDto">
		UPDATE FILE_CODE
		   SET FILE_ID        = #{fileId},
		       CODE_ID        = #{errorId}
		 WHERE FILE_ID = #{fileId} AND CODE_ID = #{errorId}
	</update>

	<!-- 删除参考文件与故障代码 -->
	<delete id="delete" parameterType="com.june.dto.back.bussiness.referenceFile.FileCodeDto">
	  DELETE FROM FILE_CODE 
	  WHERE 1=1 
	  <if test="fileId!=null and fileId != ''">
	  	AND FILE_ID = #{fileId} 
	  </if>
	  <if test="errorId !=null and errorId != ''">
	  	AND CODE_ID = #{errorId}
	  </if>
	</delete>
</mapper>