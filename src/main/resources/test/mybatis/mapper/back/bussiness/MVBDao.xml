<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.june.dao.back.bussiness.mvb.MVBDao">
	<!-- 查询列表SQL -->
	<sql id="selectData">
		SELECT v.MVB_ID       	AS mvbId,
		       v.MVB_SYSTEM     AS system,
		       v.MVB_PORTADDR   AS portAddr,
		       v.MVB_PORTSIZE   AS portSize,
		       v.MVB_CYCLETIME  AS cycleTime,
		       v.MVB_BYTEOFFSET AS byteOffset,
		       v.MVB_BITOFFSET 	AS bitOffset,
		       v.MVB_SIGNAL 	AS signal,
		       v.MVB_DESC 		AS description,
		       v.MVB_MAX		AS max,
		       v.MVB_MIN 		AS min,
		       v.MVB_TYPE 		AS type,
		       v.MVB_MEASURE 	AS measure,
		       v.MVB_FORMULA 	AS formula,
		       v.MVB_UNIT 		AS unit,
		       v.MVB_FLAG 		AS flag,
		       v.MVB_UPPER 		AS upper,
		       v.MVB_LOWER		AS lower,
		       v.MVB_DEFAULT 	AS defaultValue,
		       v.VEHICLE_TYPE 	AS vehicle,
		       e.VEHICLE_NAME 	AS vehicleName,
		       v.ADD_USER_ID    AS addUserId,
		       v.ADD_TIME       AS addTime,
		       v.UPDATE_USER_ID AS updateUserId,
		       v.UPDATE_TIME    AS updateTime,
		       v.VERSION        AS version
		 FROM MVB_DATA v
		 LEFT JOIN VEHICLE_TYPE e ON e.VEHICLE_ID = v.VEHICLE_TYPE
		 WHERE 1 = 1
		<if test="system != null and system != ''">
			AND v.MVB_SYSTEM LIKE CONCAT(CONCAT('%', #{system}), '%')
		</if>
		<if test="vehicle != null and vehicle != ''">
			AND v.VEHICLE_TYPE = #{vehicle}
		</if>
		<if test="portAddr != null and portAddr != ''">
			AND v.MVB_PORTADDR LIKE CONCAT(CONCAT('%', #{portAddr}), '%')
		</if>
	</sql>
	<!-- 查询MVB列表 -->
	<select id="getPageList" resultType="com.june.dto.back.bussiness.mvb.MVBDto"
		parameterType="com.june.dto.back.bussiness.mvb.MVBDto">
		<include refid="pagetop" />
		<include refid="selectData" />
			ORDER BY v.ADD_TIME
		<include refid="pageend" />
	</select>
	<sql id="pagetop">
		<![CDATA[SELECT * FROM (SELECT ROWNUM AS PNUM, TNUM.* FROM ( ]]>
	</sql>
	<sql id="pageend">
		<![CDATA[) TNUM WHERE ROWNUM <= #{startadd} + #{pageSize}) TPAGE WHERE TPAGE.PNUM > #{start}]]>
	</sql>

	<!-- 查询总条数 -->
	<select id="getTotal" resultType="int">
		SELECT COUNT(1) FROM ( <include refid="selectData" /> ) T
	</select>

	<!-- 查询所有MVB列表 -->
	<select id="getList" resultType="com.june.dto.back.bussiness.mvb.MVBDto" 
		parameterType="com.june.dto.back.bussiness.mvb.MVBDto">
		<include refid="selectData" />
	</select>
	
	<!-- 根据MVBid 获取一条记录 -->
	<select id="get" parameterType="com.june.dto.back.bussiness.mvb.MVBDto" 
		resultType="com.june.dto.back.bussiness.mvb.MVBDto">
		SELECT v.MVB_ID       	AS mvbId,
		       v.MVB_SYSTEM		AS system,
		       v.MVB_PORTADDR	AS portAddr,
		       v.MVB_PORTSIZE	AS portSize,
		       v.MVB_CYCLETIME	AS cycleTime,
		       v.MVB_BYTEOFFSET	AS byteOffset,
		       v.MVB_BITOFFSET 	AS bitOffset,
		       v.MVB_SIGNAL 	AS signal,
		       v.MVB_DESC  		AS description,
		       v.MVB_MAX  		AS max,
		       v.MVB_MIN 		AS min,  
		       v.MVB_TYPE 		AS type,
		       v.MVB_MEASURE 	AS measure,
		       v.MVB_FORMULA 	AS formula,
		       v.MVB_UNIT 		AS unit,
		       v.MVB_FLAG 		AS flag,
		       v.MVB_UPPER 		AS upper,
		       v.MVB_LOWER 		AS lower,
		       v.MVB_DEFAULT 	AS defaultValue,
		       v.VEHICLE_TYPE 	AS vehicle,
		       v.ADD_USER_ID    AS addUserId,
		       v.ADD_TIME       AS addTime,
		       v.UPDATE_USER_ID AS updateUserId,
		       v.UPDATE_TIME    AS updateTime,
		       v.VERSION        AS version
		  FROM MVB_DATA v WHERE v.MVB_ID = #{mvbId}
	</select>
	
	<!-- 批量添加MVB信息 -->
	<insert id="addlist" parameterType="java.util.List">
		<![CDATA[ INSERT INTO MVB_DATA (
		  	MVB_ID    		,
			MVB_SYSTEM      ,
			MVB_PORTADDR    ,
			MVB_PORTSIZE    ,
			MVB_CYCLETIME   ,
			MVB_BYTEOFFSET  ,
			MVB_BITOFFSET   ,
			MVB_SIGNAL      ,
			MVB_DESC        ,
			MVB_MAX         ,
			MVB_MIN         ,
			MVB_TYPE        ,
			MVB_MEASURE     ,
			MVB_FORMULA     ,
			MVB_UNIT        ,
			MVB_FLAG        ,
			MVB_UPPER       ,
			MVB_LOWER       ,
			MVB_DEFAULT     ,
			VEHICLE_TYPE 	,
			ADD_USER_ID 	,
			ADD_TIME 		,
			UPDATE_USER_ID 	,
			UPDATE_TIME 	,
			VERSION ) ]]>
		<foreach collection="list" item="item" index="index" separator="UNION ALL">
		   SELECT 
			   MVB_DATA_ID(),
			   #{item.system},
			   #{item.portAddr},
			   #{item.portSize},
			   #{item.cycleTime},
			   #{item.byteOffset},
			   #{item.bitOffset},
			   #{item.signal},
			   #{item.description},
			   #{item.max},
			   #{item.min},
			   #{item.type},
			   #{item.measure},
			   #{item.formula},
			   #{item.unit},
			   #{item.flag},
			   #{item.upper},
			   #{item.lower},
			   #{item.defaultValue},
			   #{item.vehicle},
			   #{item.addUserId},
			   SYSDATE,
			   #{item.addUserId},
			   SYSDATE,
			   0
		   FROM DUAL
		</foreach>
	</insert>
	
	<!-- 添加MVB信息 -->
	<insert id="add" parameterType="com.june.dto.back.bussiness.mvb.MVBDto">
		<selectKey keyProperty="errorId" resultType="java.lang.String" order="BEFORE">
			SELECT SEQ_MVB_DATA.NEXTVAL AS MVB_ID FROM DUAL 
		</selectKey>
		INSERT INTO MVB_DATA (	  
			MVB_ID    		,
			MVB_SYSTEM      ,
			MVB_PORTADDR    ,
			MVB_PORTSIZE    ,
			MVB_CYCLETIME   ,
			MVB_BYTEOFFSET  ,
			MVB_BITOFFSET   ,
			MVB_SIGNAL      ,
			MVB_DESC        ,
			MVB_MAX         ,
			MVB_MIN         ,
			MVB_TYPE        ,
			MVB_MEASURE     ,
			MVB_FORMULA     ,
			MVB_UNIT        ,
			MVB_FLAG        ,
			MVB_UPPER       ,
			MVB_LOWER       ,
			MVB_DEFAULT     ,
			VEHICLE_TYPE 	,
			ADD_USER_ID 	,
			ADD_TIME 		,
			UPDATE_USER_ID 	,
			UPDATE_TIME 	,
			VERSION )
		VALUES
		  (#{mvbId},
		   #{system},
		   #{portAddr},
		   #{portSize},
		   #{cycleTime},
		   #{byteOffset},
		   #{bitOffset},
		   #{signal},
		   #{description},
		   #{max},
		   #{min},
		   #{type},
		   #{measure},
		   #{formula},
		   #{unit},
		   #{flag},
		   #{upper},
		   #{lower},
		   #{defaultValue},
		   #{vehicle},
		   #{addUserId},
		   SYSDATE,
		   #{addUserId},
		   SYSDATE,
		   0)
	</insert>

	<!-- 编辑MVB信息 -->
	<update id="update" parameterType="com.june.dto.back.bussiness.mvb.MVBDto">
		UPDATE MVB_DATA
		   SET MVB_SYSTEM     	= #{system},
		       MVB_PORTADDR     = #{portAddr},
		       MVB_PORTSIZE     = #{portSize},
		       MVB_CYCLETIME   	= #{cycleTime},
		       MVB_BYTEOFFSET 	= #{byteOffset},
		       MVB_BITOFFSET 	= #{bitOffset},
		       MVB_SIGNAL   	= #{signal},
		       MVB_DESC  		= #{description},
		       MVB_MAX  		= #{max},
		       MVB_MIN  		= #{min},
		       MVB_TYPE  	  	= #{type},
		       MVB_MEASURE    	= #{measure},
		       MVB_FORMULA   	= #{formula},
		       MVB_UNIT 		= #{unit},
		       MVB_FLAG   	 	= #{flag},
		       MVB_UPPER   	 	= #{upper},
		       MVB_LOWER   	 	= #{lower},
		       MVB_DEFAULT    	= #{defaultValue},
		       VEHICLE_TYPE    	= #{vehicle},
		       UPDATE_USER_ID 	= #{sys_user},
		       UPDATE_TIME    	= SYSDATE,
		       VERSION        	= VERSION + 1
		 WHERE MVB_ID 			= #{mvbId}
	</update>

	<!-- 删除MVB -->
	<delete id="delete" parameterType="com.june.dto.back.bussiness.mvb.MVBDto">
	DELETE FROM MVB_DATA WHERE 1=1
	<if test="mvbId != null and mvbId != '' ">
		AND MVB_ID = #{mvbId}
	</if>
	<if test="vehicle != null and vehicle != '' ">
		AND VEHICLE_TYPE = #{vehicle}
	</if>
	</delete>
</mapper>