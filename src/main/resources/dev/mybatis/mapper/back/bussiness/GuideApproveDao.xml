<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.june.dao.back.bussiness.guide.GuideApproveDao">
	<!-- 查询列表SQL -->
	<sql id="selectData">
		SELECT v.GUIDE_APPROVE_ID AS approveId,
		       v.GUIDE_NAME AS guideName,
		       v.GUIDE_INFO AS guideInfo,
		       v.DIRECTORY_PATH AS ftpPath,
		       v.TO_PATH AS toPath,
		       CASE v.APPROVE_STATE
		         WHEN 1 THEN
		          '审批通过'
		         WHEN 2 THEN
		          '审批未通过'
		         ELSE
		          '未审批'
		       END AS approveState,
		       v.APPROVE_USER_ID AS approveUserId,
		       v.APPROVE_TIME AS approveTime,
		       v.APPROVE_INFO AS approveInfo,
		       v.VEHICLE_TYPE AS vehicleId,
		       t.VEHICLE_NAME AS vehicleName,
		       v.IS_EMERGENCY AS emergency,
		       v.ADD_UPDATE AS operateType,
		       case v.ADD_UPDATE
		         when '0' then
		          '新增操作指南'
		         when '1' then
		          '修改指南图文步骤'
		         when '2' then
		          '增加指南图文步骤'
		         when '3' then
		          '修改指南视频'
		         else
		          '未知'
		       end AS operateDesc,
		       v.GUIDE_ID AS guideId,
		       v.XML_STEP AS xmlStep,
		       v.XML_IMAGE AS xmlImage,
		       v.XML_TEXT AS xmlText,
		       v.VIDEO_NAME AS videoName,
		       v.ADD_USER_ID AS addUserId,
		       v.ADD_TIME AS addTime,
		       v.UPDATE_USER_ID AS updateUserId,
		       v.UPDATE_TIME AS updateTime,
		       v.VERSION AS version
		  FROM GUIDE_APPROVE v
		  LEFT JOIN VEHICLE_TYPE t ON t.VEHICLE_ID = v.VEHICLE_TYPE
		 WHERE 1 = 1
		<if test="guideName != null and guideName != ''">
			AND v.GUIDE_NAME LIKE CONCAT(CONCAT('%', #{guideName}), '%')
		</if>
		<if test="approveState != null and approveState != ''">
			AND v.APPROVE_STATE = #{approveState}
		</if>
		<if test="emergency != null and emergency != ''">
			AND v.IS_EMERGENCY = #{emergency}
		</if>
		<if test="operateType != null and operateType != ''">
			AND v.ADD_UPDATE = #{operateType}
		</if>
		<if test="approveId != null and approveId != ''">
			AND v.GUIDE_APPROVE_ID = #{approveId}
		</if>
			ORDER BY v.APPROVE_STATE, v.ADD_TIME
	</sql>
	<!-- 查询作指南批审操列表 -->
	<select id="getPageList" resultType="com.june.dto.back.bussiness.guide.GuideApproveDto"
		parameterType="com.june.dto.back.bussiness.guide.GuideApproveDto">
		<include refid="pagetop" />
		<include refid="selectData" />
		<include refid="pageend" />
	</select>
	<sql id="pagetop">
		<![CDATA[SELECT * FROM (SELECT ROWNUM AS PNUM, TNUM.* FROM ( ]]>
	</sql>
	<sql id="pageend">
		<![CDATA[) TNUM WHERE ROWNUM <= #{startadd} + #{pageSize}) TPAGE WHERE TPAGE.PNUM > #{start}]]>
	</sql>

	<!-- 查询总条数 -->
	<select id="getTotal" resultType="int">
		SELECT COUNT(1) FROM ( <include refid="selectData" /> ) T
	</select>

	<!-- 查询所有作指南批审操列表 -->
	<select id="getList" resultType="com.june.dto.back.bussiness.guide.GuideApproveDto" 
		parameterType="com.june.dto.back.bussiness.guide.GuideApproveDto">
		<include refid="selectData" />
	</select>
	
	<!-- 根据作指南批审操id 获取一条记录 -->
	<select id="get" parameterType="com.june.dto.back.bussiness.guide.GuideApproveDto" 
		resultType="com.june.dto.back.bussiness.guide.GuideApproveDto">
		SELECT v.GUIDE_APPROVE_ID AS approveId,
		       v.GUIDE_NAME       AS guideName,
		       v.GUIDE_INFO       AS guideInfo,
		       v.DIRECTORY_PATH   AS ftpPath,
		       v.TO_PATH          AS toPath,
		       v.APPROVE_STATE 	  AS approveState,
		       v.APPROVE_USER_ID  AS approveUserId,
		       v.APPROVE_TIME     AS approveTime,
		       v.APPROVE_INFO     AS approveInfo,
		       v.VEHICLE_TYPE     AS vehicleId,
		       t.VEHICLE_NAME     AS vehicleName,
		       v.IS_EMERGENCY     AS emergency,
		       v.ADD_UPDATE       AS operateType,
		       v.GUIDE_ID         AS guideId,
		       v.XML_STEP         AS xmlStep,
		       v.XML_IMAGE        AS xmlImage,
		       v.XML_TEXT         AS xmlText,
		       v.VIDEO_NAME       AS videoName,
		       v.ADD_USER_ID      AS addUserId,
		       v.ADD_TIME         AS addTime,
		       v.UPDATE_USER_ID   AS updateUserId,
		       v.UPDATE_TIME      AS updateTime,
		       v.VERSION          AS version
		  FROM GUIDE_APPROVE v
		  LEFT JOIN VEHICLE_TYPE t ON t.VEHICLE_ID = v.VEHICLE_TYPE
		 WHERE v.GUIDE_APPROVE_ID	= #{approveId}
	</select>

	<!-- 添加作指南批审操信息 // TODO 不需要添加审批指南只对客户端做审批操作 -->
	<insert id="add" parameterType="com.june.dto.back.bussiness.guide.GuideApproveDto">
		<selectKey keyProperty="approveId" resultType="java.lang.String" order="BEFORE">
			SELECT SEQ_GUIDE_APPROVE_ID.NEXTVAL AS GUIDE_APPROVE_ID FROM DUAL 
		</selectKey>
		INSERT INTO GUIDE_APPROVE
		  (GUIDE_APPROVE_ID,
		   GUIDE_NAME,
		   GUIDE_INFO,
		   DIRECTORY_PATH,
		   TO_PATH,
		   APPROVE_STATE,
		   APPROVE_USER_ID,
		   APPROVE_TIME,
		   APPROVE_INFO,
		   VEHICLE_TYPE,
		   IS_EMERGENCY,
		   ADD_USER_ID,
		   ADD_TIME,
		   UPDATE_USER_ID,
		   UPDATE_TIME,
		   VERSION)
		VALUES
		  (#{approveId},
		   #{guideName},
		   #{guideInfo},
		   #{ftpPath},
		   #{toPath},
		   #{approveState},
		   #{approveUserId},
		   #{approveTime},
		   #{approveInfo},
		   #{vehicleId},
		   #{emergency},
		   #{addUserId},
		   SYSDATE,
		   #{addUserId},
		   SYSDATE,
		   0)
	</insert>

	<!-- 编辑作指南批审操信息 //TODO 只需要维护审批的操作，其他信息不可修改-->
	<update id="update" parameterType="com.june.dto.back.bussiness.guide.GuideApproveDto">
		UPDATE GUIDE_APPROVE
		   SET GUIDE_NAME     	= #{guideName},
		       APPROVE_STATE  	= #{approveState},
		       APPROVE_USER_ID  = #{approveUserId},
		       APPROVE_TIME  	= #{approveTime},
		       APPROVE_INFO  	= #{approveInfo},
		       UPDATE_USER_ID 	= #{sys_user},
		       UPDATE_TIME    	= SYSDATE,
		       VERSION        	= VERSION + 1
		 WHERE GUIDE_APPROVE_ID	= #{approveId}
	</update>

	<!-- 删除作指南批审操 -->
	<delete id="delete" parameterType="com.june.dto.back.bussiness.guide.GuideApproveDto">
	  DELETE FROM GUIDE_APPROVE WHERE GUIDE_APPROVE_ID = #{approveId}
	</delete>
	
	<!-- 修改审批数目 -->
	<update id="updateApproveNum" parameterType="java.lang.Integer">
		UPDATE SYS_MENU s
		   SET s.INFO_NUM = 
		   	(SELECT COUNT(1) FROM GUIDE_APPROVE g  WHERE g.APPROVE_STATE = 0)
		 WHERE s.MENU_ID = 25
	</update>
	<!-- 查询待审批的数量 -->
	<select id="getApproveInfoNumber" resultType="int">
		SELECT COUNT(1) FROM GUIDE_APPROVE g  WHERE g.APPROVE_STATE = 0
	</select>
</mapper>