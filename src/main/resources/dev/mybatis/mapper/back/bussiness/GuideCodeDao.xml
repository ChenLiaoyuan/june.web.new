<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.june.dao.back.bussiness.guide.GuideCodeDao">
	<!-- 查询列表SQL -->
	<sql id="selectData">
		SELECT v.GUIDE_ID 		AS guideId,
		       v1.GUIDE_NAME 	AS guideName,
		       v.CODE_ID 		AS errorId,
		       v2.ERROR_CODE 	AS errorCode,
		       v.ADD_USER_ID 	AS addUserId,
		       v.ADD_TIME 		AS addTime
		  FROM CODE_GUIDE v 
		  	LEFT JOIN ERROR_CODE v2 ON v2.ERROR_ID = v.CODE_ID
		  	LEFT JOIN OPERATION_GUIDE v1 ON v1.GUIDE_ID = v.GUIDE_ID
		 WHERE 1 = 1
		<if test="guideId != null and guideId != ''">
			AND v.GUIDE_ID = #{guideId}
		</if>
		<if test="errorId != null and errorId != ''">
			AND v.CODE_ID = #{errorId}
		</if>
			ORDER BY v.ADD_TIME
	</sql>
	<!-- 查询指南与故障代码关联列表 -->
	<select id="getPageList" resultType="com.june.dto.back.bussiness.guide.GuideCodeDto"
		parameterType="com.june.dto.back.bussiness.guide.GuideCodeDto">
		<include refid="pagetop" />
		<include refid="selectData" />
		<include refid="pageend" />
	</select>
	<sql id="pagetop">
		<![CDATA[SELECT * FROM (SELECT ROWNUM AS PNUM, TNUM.* FROM ( ]]>
	</sql>
	<sql id="pageend">
		<![CDATA[) TNUM WHERE ROWNUM <= #{startadd} + #{pageSize}) TPAGE WHERE TPAGE.PNUM > #{start}]]>
	</sql>
	<sql id="pagelimit">
		limit #{start}, #{pageSize}
	</sql>

	<!-- 查询总条数 -->
	<select id="getTotal" resultType="int">
		SELECT COUNT(1) FROM ( <include refid="selectData" /> ) T
	</select>

	<!-- 查询所有指南与故障代码关联列表 -->
	<select id="getList" resultType="com.june.dto.back.bussiness.guide.GuideCodeDto" 
		parameterType="com.june.dto.back.bussiness.guide.GuideCodeDto">
		<include refid="selectData" />
	</select>
	
	<!-- 根据指南与故障代码关联id 获取一条记录 -->
	<select id="get" parameterType="com.june.dto.back.bussiness.guide.GuideCodeDto" 
		resultType="com.june.dto.back.bussiness.guide.GuideCodeDto">
		SELECT v.GUIDE_ID 		AS guideId,
	           v1.GUIDE_NAME 	AS guideName,
	           v.CODE_ID 		AS errorId,
	           v2.ERROR_CODE 	AS errorCode,
	           v.ADD_USER_ID 	AS addUserId,
	           v.ADD_TIME 		AS addTime
	      FROM CODE_GUIDE v 
	        LEFT JOIN ERROR_CODE v2 ON v2.ERROR_ID = v.CODE_ID
	        LEFT JOIN OPERATION_GUIDE v1 ON v1.GUIDE_ID = v.GUIDE_ID
	     WHERE  v.GUIDE_ID 	= #{guideId} 
	     	AND v.CODE_ID 	= #{errorId}
	</select>

	<!-- 添加指南与故障代码关联信息 -->
	<insert id="add" parameterType="com.june.dto.back.bussiness.guide.GuideCodeDto">
		INSERT INTO CODE_GUIDE (GUIDE_ID, CODE_ID, ADD_USER_ID, ADD_TIME)
		VALUES (#{guideId}, #{errorId}, #{addUserId}, SYSDATE )
	</insert>

	<!-- 批量添加 -->
	<insert id="addList" parameterType="java.util.List">
		<![CDATA[ 
		INSERT INTO CODE_GUIDE
		  (GUIDE_ID,
		   CODE_ID,
		   ADD_USER_ID,
		   ADD_TIME) ]]>
		<foreach collection="list" item="item" index="index" separator="UNION ALL">
		   SELECT
			   #{item.guideId},
			   #{item.errorId},
			   #{item.addUserId},
			   SYSDATE 
		   FROM DUAL
		</foreach>
	</insert>
	
	<!-- 编辑指南与故障代码关联信息 -->
	<update id="update" parameterType="com.june.dto.back.bussiness.guide.GuideCodeDto">
		UPDATE CODE_GUIDE
		   SET GUIDE_ID = #{guideId},
		       CODE_ID	= #{errorId}
		 WHERE GUIDE_ID = #{guideId} 
		 	AND CODE_ID = #{errorId}
	</update>

	<!-- 删除指南与故障代码关联 -->
	<delete id="delete" parameterType="com.june.dto.back.bussiness.guide.GuideCodeDto">
	  DELETE FROM CODE_GUIDE v WHERE 1=1 
		<if test="guideId != null and guideId != ''">
			AND v.GUIDE_ID = #{guideId}
		</if>
		<if test="errorId != null and errorId != ''">
			AND v.CODE_ID = #{errorId}
		</if>
	</delete>
</mapper>