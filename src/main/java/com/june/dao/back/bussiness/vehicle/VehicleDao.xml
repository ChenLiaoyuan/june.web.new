<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.june.dao.back.bussiness.vehicle.VehicleDao">

	<sql id="selectData">
		SELECT vt.VEHICLE_ID AS vehicleId,
	       vt.VEHICLE_NAME   AS vehicleName,
	       vt.VEHICLE_DESC   AS vehicleDesc,
	       vt.FTP_PATH   	 AS ftpPath,
	       vt.ADD_USER_ID    AS addUserId,
	       vt.ADD_TIME       AS addTime,
	       vt.UPDATE_USER_ID AS updateUserId,
	       vt.UPDATE_TIME    AS updateTime,
	       vt.VERSION        AS version
	  FROM VEHICLE_TYPE vt
		WHERE 1=1
		<if test="vehicleId != null and vehicleId != ''">
			AND vt.VEHICLE_ID #{vehicleId}
		</if>
		<if test="vehicleName != null and vehicleName != ''">
			AND vt.VEHICLE_NAME LIKE CONCAT(CONCAT('%', #{vehicleName}), '%')
		</if>
		<if test="vehicleDesc != null and vehicleDesc != ''">
			AND vt.VEHICLE_DESC LIKE CONCAT(CONCAT('%', #{vehicleDesc}), '%')
		</if>
		ORDER BY vt.ADD_TIME
	</sql>
	<!-- 查询车型列表 -->
	<select id="getPageList" resultType="com.june.dto.back.bussiness.vehicle.VehicleDto"
		parameterType="com.june.dto.back.bussiness.vehicle.VehicleDto">
		<include refid="pagetop" />
		<include refid="selectData" />
		<include refid="pageend" />
	</select>
	<sql id="pagetop">
		<![CDATA[SELECT * FROM (SELECT ROWNUM AS PNUM, TNUM.* FROM ( ]]>
	</sql>
	<sql id="pageend">
		<![CDATA[) TNUM WHERE ROWNUM <= #{startadd} + #{pageSize}) TPAGE WHERE TPAGE.PNUM > #{start}]]>
	</sql>
	<!-- 查询总条数 -->
	<select id="getTotal" resultType="int">
		SELECT COUNT(1) FROM ( <include refid="selectData" /> ) T
	</select>

	<!-- 查询所有车型列表 -->
	<select id="getList" resultMap="getAllVehicles" parameterType="com.june.dto.back.bussiness.vehicle.VehicleDto">
		SELECT vt.VEHICLE_ID     AS vehicleId,
		       vt.VEHICLE_NAME   AS vehicleName,
		       vt.VEHICLE_ID   	 AS vehicleDesc,
		       vt.FTP_PATH 		 AS ftpPath,
		       vt.ADD_USER_ID    AS addUserId,
		       vt.ADD_TIME       AS addTime,
		       vt.UPDATE_USER_ID AS updateUserId,
		       vt.UPDATE_TIME    AS updateTime,
		       vt.VERSION        AS version
		  FROM VEHICLE_TYPE vt
		 WHERE 1 = 1
	</select>
	<resultMap type="com.june.dto.back.bussiness.vehicle.VehicleDto" id="getAllVehicles">
		<id property="vehicleId" column="VEHICLE_ID" />
		<collection property="users" javaType="ArrayList" column="vehicleId" 
			ofType="com.june.dto.back.system.base.UserInfoDto" select="getUsersByVehicle">
		</collection>
	</resultMap>
	<select id="getUsersByVehicle" resultType="com.june.dto.back.system.base.UserInfoDto">
		SELECT uv.USER_ID AS userId, su.USER_NAME AS userName
		  FROM USER_VEHICLE uv
		  left join SYS_USER su on uv.USER_ID = su.USER_ID
		 WHERE uv.VEHICLE_ID = #{vehicleId}
	</select>
	
	<!-- 根据车型id 获取一条记录 -->
	<select id="get" parameterType="com.june.dto.back.bussiness.vehicle.VehicleDto" 
		resultType="com.june.dto.back.bussiness.vehicle.VehicleDto">
			SELECT 
				vt.VEHICLE_ID     AS vehicleId,
		        vt.VEHICLE_NAME   AS vehicleName,
		        vt.VEHICLE_DESC   AS vehicleDesc,
		        vt.FTP_PATH 	  AS ftpPath,
		        vt.ADD_USER_ID    AS addUserId,
		        vt.ADD_TIME       AS addTime,
		        vt.UPDATE_USER_ID AS updateUserId,
		        vt.UPDATE_TIME    AS updateTime,
		        vt.VERSION        AS version
			FROM 
				VEHICLE_TYPE vt 
			WHERE 
				vt.VEHICLE_ID = #{vehicleId}
	</select>

	<!-- 添加车型信息 -->
	<insert id="add" parameterType="com.june.dto.back.bussiness.vehicle.VehicleDto">
		<selectKey keyProperty="vehicleId" resultType="java.lang.String" order="BEFORE">
			<!-- SELECT SYS_GUID() AS VEHICLE_ID FROM DUAL  -->
			SELECT SEQ_VEHICLE_ID.NEXTVAL as VEHICLE_ID from DUAL 
		</selectKey>
		INSERT INTO 
			VEHICLE_TYPE (
				VEHICLE_ID,
				VEHICLE_NAME,
				VEHICLE_DESC,
				FTP_PATH,
				ADD_USER_ID,
				ADD_TIME,
				UPDATE_USER_ID,
				UPDATE_TIME,
				VERSION
			) VALUES (
				#{vehicleId},
				#{vehicleName},
				#{vehicleDesc},
				#{ftpPath},
				#{addUserId},
				SYSDATE,
				#{addUserId},
				SYSDATE,
				0 
			)
	</insert>

	<!-- 编辑车型信息 -->
	<update id="update" parameterType="com.june.dto.back.bussiness.vehicle.VehicleDto">
		UPDATE VEHICLE_TYPE
		SET
			VEHICLE_NAME 	= #{vehicleName},
			VEHICLE_DESC 	= #{vehicleDesc},
			FTP_PATH 		= #{ftpPath},
			UPDATE_USER_ID 	= #{sys_user},
			UPDATE_TIME 	= SYSDATE,
			VERSION 		= VERSION + 1
		WHERE VEHICLE_ID 	= #{vehicleId}
	</update>

	<!-- 删除车型 -->
	<delete id="delete" parameterType="com.june.dto.back.bussiness.vehicle.VehicleDto">
	  DELETE FROM VEHICLE_TYPE WHERE VEHICLE_ID = #{vehicleId}
	</delete>
	
	<!-- 根据车型ID和用户ID，获取一条车型-用户信息 -->
	<select id="getVehicleUserById" parameterType="com.june.dto.back.bussiness.vehicle.VehicleUser"
		resultType="com.june.dto.back.bussiness.vehicle.VehicleUser">
		SELECT SU.USER_ID     AS userId,
		       SU.VEHICLE_ID  AS vehicleId,
		       SU.ADD_USER_ID AS addUserId,
		       SU.ADD_TIME    AS addTime
		  FROM USER_VEHICLE SU
		 WHERE 1 = 1
		   AND SU.USER_ID = #{userId}
		   AND SU.VEHICLE_ID = #{vehicleId}
	</select>

	<!-- 根据车型ID获取所有的车型用户信息 -->
	<select id="getVehicleUsers" parameterType="com.june.dto.back.bussiness.vehicle.VehicleDto"
		resultType="com.june.dto.back.bussiness.vehicle.VehicleUser">
		SELECT SU.USER_ID     AS userId,
		       SU.VEHICLE_ID  AS vehicleId,
		       SU.ADD_USER_ID AS addUserId,
		       SU.ADD_TIME    AS addTime
		  FROM USER_VEHICLE SU
		 WHERE 1 = 1
		   AND SU.VEHICLE_ID = #{vehicleId}
	</select>

	<!-- 添加一条车型-用户信息 -->
	<insert id="addVehicleUser" parameterType="com.june.dto.back.bussiness.vehicle.VehicleUser">
		INSERT INTO USER_VEHICLE 
			( USER_ID, VEHICLE_ID, ADD_USER_ID, ADD_TIME ) 
		VALUES 
			( #{userId}, #{vehicleId}, #{sys_user}, SYSDATE )
	</insert>

	<!-- 根据车型ID删除所有的车型-用户信息记录 -->
	<delete id="deleteVehicleUsers" parameterType="com.june.dto.back.bussiness.vehicle.VehicleDto">
		DELETE FROM USER_VEHICLE WHERE VEHICLE_ID = #{vehicleId}
	</delete>
	
	<!-- 根据车型ID和用户ID删除一条车型-用户信息记录 -->
	<delete id="deleteVehicleUser" parameterType="com.june.dto.back.bussiness.vehicle.VehicleUser">
		DELETE FROM USER_VEHICLE WHERE VEHICLE_ID = #{vehicleId} AND USER_ID = #{userId}
	</delete>
	
	<!-- 查询所有车型下拉列表 -->
	<select id="getDrops" resultType="com.june.dto.back.common.TreeDto">
		SELECT 
			v.VEHICLE_ID 	AS id,
			v.VEHICLE_NAME 	AS name
		FROM VEHICLE_TYPE v 
		WHERE 1=1
	</select>
</mapper>