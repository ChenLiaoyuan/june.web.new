<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.june.dao.back.bussiness.referenceFile.ReferenceFileDao">
	<!-- 查询列表SQL -->
	<sql id="selectData">
		SELECT v.FILE_ID 		AS referenceFileId,
		       v.FILE_NAME 		AS referenceFileName,
		       v.FTP_PATH 		AS ftpPath,
		       v.VEHICLE_TYPE 	AS vehicleId,
		       <!-- e.ERROR_CODE 	AS errorCode, -->
		       v.ERROR_CODE 	AS errorId,
		       v.SUB_SYSTEM 	AS system,
		       v.ADD_USER_ID 	AS addUserId,
		       v.ADD_TIME 		AS addTime,
		       v.UPDATE_USER_ID AS updateUserId,
		       v.UPDATE_TIME 	AS updateTime,
		       v.VERSION 		AS version
		  FROM REFERENCE_FILE v 
		  <!-- LEFT JOIN ERROR_CODE e ON e.ERROR_ID = v.ERROR_CODE -->
		 WHERE 1 = 1
		<if test="referenceFileName != null and referenceFileName != ''">
			AND v.FILE_NAME LIKE CONCAT(CONCAT('%', #{referenceFileName}), '%')
		</if>
		<if test="vehicleId != null and vehicleId != ''">
			AND v.VEHICLE_TYPE = #{vehicleId}
		</if>
		<if test="referenceFileId != null and referenceFileId != ''">
			AND v.FILE_ID = #{referenceFileId}
		</if>
		<!-- <if test="errorCode != null and errorCode != ''">
			AND v.ERROR_CODE LIKE CONCAT(CONCAT('%', #{errorCode}), '%')
		</if> -->
			ORDER BY v.ADD_TIME
	</sql>
	<!-- 查询参考文件列表 -->
	<select id="getPageList" resultType="com.june.dto.back.bussiness.referenceFile.ReferenceFileDto"
		parameterType="com.june.dto.back.bussiness.referenceFile.ReferenceFileDto">
		<include refid="pagetop" />
		<include refid="selectData" />
		<include refid="pageend" />
	</select>
	<sql id="pagetop">
		<![CDATA[SELECT * FROM (SELECT ROWNUM AS PNUM, TNUM.* FROM ( ]]>
	</sql>
	<sql id="pageend">
		<![CDATA[) TNUM WHERE ROWNUM <= #{startadd} + #{pageSize}) TPAGE WHERE TPAGE.PNUM > #{start}]]>
	</sql>
	<sql id="pagelimit">
		limit #{start}, #{pageSize}
	</sql>

	<!-- 查询总条数 -->
	<select id="getTotal" resultType="int">
		SELECT COUNT(1) FROM ( <include refid="selectData" /> ) T
	</select>

	<!-- 查询所有参考文件列表 -->
	<select id="getList" resultType="com.june.dto.back.bussiness.referenceFile.ReferenceFileDto" 
		parameterType="com.june.dto.back.bussiness.referenceFile.ReferenceFileDto">
		<include refid="selectData" />
	</select>
	
	<!-- 根据参考文件id 获取一条记录 -->
	<select id="get" parameterType="com.june.dto.back.bussiness.referenceFile.ReferenceFileDto" 
		resultType="com.june.dto.back.bussiness.referenceFile.ReferenceFileDto">
		SELECT v.FILE_ID 		AS referenceFileId,
		       v.FILE_NAME 		AS referenceFileName,
		       v.FTP_PATH 		AS ftpPath,
		       v.VEHICLE_TYPE 	AS vehicleId,
		       v.ERROR_CODE 	AS errorCode,
		       v.SUB_SYSTEM 	AS system,
		       v.ADD_USER_ID 	AS addUserId,
		       v.ADD_TIME 		AS addTime,
		       v.UPDATE_USER_ID AS updateUserId,
		       v.UPDATE_TIME 	AS updateTime,
		       v.VERSION 		AS version
		  FROM REFERENCE_FILE v
		 WHERE v.FILE_ID = 	#{referenceFileId}
	</select>

	<!-- 添加参考文件信息 -->
	<insert id="add" parameterType="com.june.dto.back.bussiness.referenceFile.ReferenceFileDto">
		<selectKey keyProperty="referenceFileId" resultType="java.lang.String" order="BEFORE">
			SELECT SEQ_FILE_ID.NEXTVAL AS FILE_ID FROM DUAL 
		</selectKey>
		INSERT INTO REFERENCE_FILE
		  (FILE_ID,
		   FILE_NAME,
		   FTP_PATH,
		   VEHICLE_TYPE,
		   ERROR_CODE,
		   SUB_SYSTEM,
		   ADD_USER_ID,
		   ADD_TIME,
		   UPDATE_USER_ID,
		   UPDATE_TIME,
		   VERSION)
		VALUES
		  (#{referenceFileId},
		   #{referenceFileName},
		   #{ftpPath},
		   #{vehicleId},
		   #{errorCode},
		   #{system},
		   #{addUserId},
		   SYSDATE,
		   #{addUserId},
		   SYSDATE,
		   0)
	</insert>

	<!-- 编辑参考文件信息 -->
	<update id="update" parameterType="com.june.dto.back.bussiness.referenceFile.ReferenceFileDto">
		UPDATE REFERENCE_FILE
		   SET FILE_NAME      = #{referenceFileName},
		       FTP_PATH       = #{ftpPath},
		       VEHICLE_TYPE   = #{vehicleId},
		       ERROR_CODE  	  = #{errorCode},
		       SUB_SYSTEM 	  = #{system},
		       UPDATE_USER_ID = #{sys_user},
		       UPDATE_TIME    = SYSDATE,
		       VERSION        = VERSION + 1
		 WHERE FILE_ID 		  = #{referenceFileId}
	</update>

	<!-- 删除参考文件 -->
	<delete id="delete" parameterType="com.june.dto.back.bussiness.referenceFile.ReferenceFileDto">
	  DELETE FROM REFERENCE_FILE WHERE FILE_ID = #{referenceFileId}
	</delete>
	<!-- 下拉数据 -->
	<select id="getDrops" resultType="com.june.dto.back.common.TreeDto"
		 parameterType="com.june.dto.back.bussiness.referenceFile.ReferenceFileDto">
		SELECT 
			v.FILE_ID 		AS id,
			v.FILE_NAME 	AS name
		FROM REFERENCE_FILE v 
		WHERE 1=1	
		<if test="vehicleId != null and vehicleId != ''">
			AND v.VEHICLE_TYPE = #{vehicleId}
		</if>
		<if test="errorId != null and errorId != ''">
			AND v.ERROR_CODE = #{errorId}
		</if>	
	</select>
</mapper>