<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.june.dao.back.bussiness.guide.GuideDao">
	<!-- 查询列表SQL -->
	<sql id="selectData">
		SELECT
			v.GUIDE_ID AS guideId,
			v.GUIDE_NAME AS guideName,
			CASE v.IS_EMERGENCY
		WHEN 1 THEN
			'是'
		ELSE
			'否'
		END AS emergency,
		 v.FTP_PATH AS ftpPath,
		 v.VEHICLE_TYPE AS vehicleId,
		 T .VEHICLE_NAME AS vehicleName,
		 v1.errorCode,
		 v.ADD_USER_ID AS addUserId,
		 v.ADD_TIME AS addTime,
		 v.UPDATE_USER_ID AS updateUserId,
		 v.UPDATE_TIME AS updateTime,
		 v. VERSION AS VERSION
		FROM
			OPERATION_GUIDE v
		LEFT JOIN VEHICLE_TYPE T ON T .VEHICLE_ID = v.VEHICLE_TYPE,
		 (
			SELECT
				G .GUIDE_ID AS guideId,
				wm_concat (E .ERROR_CODE) AS errorCode
			FROM
				OPERATION_GUIDE G
			LEFT JOIN CODE_GUIDE c ON c.GUIDE_ID = G .GUIDE_ID
			LEFT JOIN ERROR_CODE E ON E .ERROR_ID = c.CODE_ID
			GROUP BY
				G .GUIDE_ID
		) v1
		WHERE
			v.GUIDE_ID = v1.guideId
		<if test="guideName != null and guideName != ''">
			AND v.GUIDE_NAME LIKE CONCAT(CONCAT('%', #{guideName}), '%')
		</if>
		<if test="emergency != null and emergency != ''">
			AND v.IS_EMERGENCY = #{emergency}
		</if>
		<if test="guideId != null and guideId != ''">
			AND v.GUIDE_ID = #{guideId}
		</if>
		<if test="vehicleId != null and vehicleId != ''">
			AND v.VEHICLE_TYPE = #{vehicleId}
		</if>
		<if test="ftpPath != null and ftpPath != ''">
			AND v.FTP_PATH LIKE CONCAT(CONCAT('%', #{ftpPath}), '%')
		</if>
			ORDER BY v.ADD_TIME
	</sql>
	<!-- 查询操作指南列表 -->
	<select id="getPageList" resultType="com.june.dto.back.bussiness.guide.GuideDto"
		parameterType="com.june.dto.back.bussiness.guide.GuideDto">
		<include refid="pagetop" />
		<include refid="selectData" />
		<include refid="pageend" />
	</select>
	<sql id="pagetop">
		<![CDATA[SELECT * FROM (SELECT ROWNUM AS PNUM, TNUM.* FROM ( ]]>
	</sql>
	<sql id="pageend">
		<![CDATA[) TNUM WHERE ROWNUM <= #{startadd} + #{pageSize}) TPAGE WHERE TPAGE.PNUM > #{start}]]>
	</sql>
	<sql id="pagelimit">
		limit #{start}, #{pageSize}
	</sql>

	<!-- 查询总条数 -->
	<select id="getTotal" resultType="int">
		SELECT COUNT(1) FROM ( <include refid="selectData" /> ) T
	</select>

	<!-- 查询所有操作指南列表 -->
	<select id="getList" resultType="com.june.dto.back.bussiness.guide.GuideDto" 
		parameterType="com.june.dto.back.bussiness.guide.GuideDto">
		<include refid="selectData" />
	</select>
	
	<!-- 根据操作指南id 获取一条记录 -->
	<select id="get" parameterType="com.june.dto.back.bussiness.guide.GuideDto" 
		resultType="com.june.dto.back.bussiness.guide.GuideDto">
		SELECT v.GUIDE_ID AS guideId,
		       v.GUIDE_NAME AS guideName,
		       v.IS_EMERGENCY AS emergency,
		       v.FTP_PATH AS ftpPath,
		       v.VEHICLE_TYPE AS vehicleId,
		       T .VEHICLE_NAME AS vehicleName,
		       v1.errorCode,
		       v1.errorId,
		       v.ADD_USER_ID AS addUserId,
		       v.ADD_TIME AS addTime,
		       v.UPDATE_USER_ID AS updateUserId,
		       v.UPDATE_TIME AS updateTime,
		       v. VERSION AS VERSION
		  FROM OPERATION_GUIDE v
		  LEFT JOIN VEHICLE_TYPE T ON T.VEHICLE_ID = v.VEHICLE_TYPE,
		 (SELECT G .GUIDE_ID AS guideId, wm_concat(E.ERROR_CODE) AS errorCode,
		 wm_concat(e.ERROR_ID) AS errorId
		                                 FROM OPERATION_GUIDE G
		                                 LEFT JOIN CODE_GUIDE c ON c.GUIDE_ID = G
		                               .GUIDE_ID
		                                 LEFT JOIN ERROR_CODE E ON E.ERROR_ID =
		                                                           c.CODE_ID
		                                GROUP BY G .GUIDE_ID) v1
		 WHERE v.GUIDE_ID = v1.guideId
			AND v.GUIDE_ID = #{guideId}
	</select>

	<!-- 添加操作指南信息 -->
	<insert id="add" parameterType="com.june.dto.back.bussiness.guide.GuideDto">
		<selectKey keyProperty="guideId" resultType="java.lang.String" order="BEFORE">
			SELECT SEQ_GUIDE_ID.NEXTVAL AS GUIDE_ID FROM DUAL 
		</selectKey>
		INSERT INTO OPERATION_GUIDE
		  (GUIDE_ID,
		   GUIDE_NAME,
		   IS_EMERGENCY,
		   FTP_PATH,
		   VEHICLE_TYPE,
		   ADD_USER_ID,
		   ADD_TIME,
		   UPDATE_USER_ID,
		   UPDATE_TIME,
		   VERSION)
		VALUES
		  (#{guideId},
		   #{guideName},
		   #{emergency},
		   #{ftpPath},
		   #{vehicleId},
		   #{addUserId},
		   SYSDATE,
		   #{addUserId},
		   SYSDATE,
		   0)
	</insert>

	<!-- 编辑操作指南信息 -->
	<update id="update" parameterType="com.june.dto.back.bussiness.guide.GuideDto">
		UPDATE OPERATION_GUIDE
		   SET GUIDE_NAME     = #{guideName},
		       IS_EMERGENCY   = #{emergency},
		       FTP_PATH       = #{ftpPath},
		       VEHICLE_TYPE   = #{vehicleId},
		       <if test="fileTime != null">
		       FILE_TIME 	  = #{fileTime},
		       </if>
		       <if test="videoTime != null">
		       VIDEO_TIME 	  = #{videoTime},
		       </if>
		       UPDATE_USER_ID = #{sys_user},
		       UPDATE_TIME    = SYSDATE,
		       VERSION        = VERSION + 1
		 WHERE GUIDE_ID 	  = #{guideId}
	</update>

	<!-- 删除操作指南 -->
	<delete id="delete" parameterType="com.june.dto.back.bussiness.guide.GuideDto">
	  DELETE FROM OPERATION_GUIDE WHERE GUIDE_ID = #{guideId}
	</delete>
	<!-- 下拉数据 -->
	<select id="getDrops" resultType="com.june.dto.back.common.TreeDto">
		SELECT 
			v.GUIDE_ID 		AS id,
			v.GUIDE_NAME 	AS name
		FROM OPERATION_GUIDE v 
		WHERE 1=1
	</select>
</mapper>